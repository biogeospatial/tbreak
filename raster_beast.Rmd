---
title: "BEAST with spatial data"
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
---

Load needed libraries. Install if necessary.

```{r}

#  convoluted leftovers from initial version
#  should just load tbreak directly
pack_list = c("tbreak")
install_list = pack_list[!(pack_list %in% installed.packages()[,"Package"])]
if(length(install_list)) {
  library ("remotes")
  install_github("biogeospatial/tbreak")
}

for (p in pack_list) {
  library(p, character.only = TRUE)
}

#  Other libs needed below
pack_list = c("svDialogs", "terra", "stringi")
install_list = pack_list[!(pack_list %in% installed.packages()[,"Package"])]
if(length(install_list)) {
  install.packages(install_list)
}
for (p in pack_list) {
  library(p, character.only = TRUE)
}


```

Now load the file we want and display some of its properties, and the
first band.

Make sure you load a geotiff or netcdf file with *ONLY ONE INDEX*, e.g.
EVI or NDVI, not both. The code does not handle more than that and weird
things will happen.

```{r}

fname = file.choose()

raster = rast(fname)

#  some don't have it 
if (any(is.na(terra::time(raster)))) {
  raster = tbreak:::assign_time_to_raster(raster)
}
if (any(minmax(raster)[1,] < -0.25)) {
  raster[raster < -0.25] = NA
}


dim (raster)

time(raster)[1:6]

t1 = time(raster)[1]

plot (raster[[1]], main = as.character(t1))

#  initialise for later
coord_string = ""

```
Generate a beast result for a single cell and plot it.  

This is useful when the raster is too large to run the beast analysis on. 

Rerun this and the next few steps with different coords to explore your data.

The coordinates to enter are obtained by right clicking on the map in
ArcGIS and choosing "Copy Coordinates".

In ArcGIS:

Make sure the map's display units uses either the MODIS Sinusoidal coordinate 
system or WGS 1984. These can be checked and set under the map's properties 
(right click on the map name in the table of contents). 

The display units can also be changed by clicking the drop down to the
right of the coordinate at the bottom of the map pane.


```{r}

response = svDialogs::dlg_input(
  message = "Enter a coordinate from ArcGIS (MODIS or WGS84 coord sys)", 
  default = coord_string
)

resp = response$res
if (length (resp)) {
  coord_string = resp
  ts_res = tbreak:::calc_and_plot_beast_modis_coord (raster, coord = coord_string)
}


```


Generate a bfast output for the same coord, or a different one if preferred.

```{r}

response = svDialogs::dlg_input(
  message = "Enter a coordinate from ArcGIS (MODIS or WGS84 coord sys)", 
  default = coord_string
)

resp = response$res
if (length (resp)) {
  coord_string = resp
  bfast_res = tbreak:::plot_bfast_modis_coord (raster, coord = coord_string, h=1/7)
}


```
Generate a plain time series plot for the same coord, or a different 
one if preferred.

This is mostly useful for diagnostic checks as the bfast plot 
includes the time series as the top plot.  

```{r}

response = svDialogs::dlg_input(
  message = "Enter a coordinate from ArcGIS (MODIS or WGS84 coord sys)", 
  default = coord_string
)

resp = response$res
if (length (resp)) {
  coord_string = resp
  ts_res = tbreak:::plot_ts_modis_coord (raster, coord = coord_string)
}


```


Now run beast on the loaded raster. This might take a while.

```{r}

#  Try to gracefully handle errors without overwriting 
#  a pre-existing beast_raster object if we fail.
#  That said, stopping the session kills it all anyway.
beast_result_tmp = tryCatch({
    tbreak:::beast_modis (raster)
}, error = function(e) {
    stop ("Unable to process data")
})

beast_result = beast_result_tmp
plot (beast_result)
rm (beast_result_tmp)

```


Plot the result for one cell from a "beasted" raster.  

This is probably redundant since you can generate the plot from the
raster directly but does avoid some recalculation.



```{r}


response = svDialogs::dlg_input(
  message = "Enter a coordinate from ArcGIS (MODIS or WGS84 coord sys)",
  default = coord_string
)

resp = response$res
if (length (resp)) {
  coord_string = resp
  tbreak:::plot_beast_modis_coord (beast_result, coord = coord_string)
}


```

Now export the beast results to a set of rasters.

```{r}

output_dir = svDialogs::dlgDir()$res

output_prefix = svDialogs::dlg_input(message = "Filename prefix", default="")$res

save_flag      = svDialogs::dlg_list  (choices = c("No", "Yes"), title = "Overwrite existing files?")$res
overwrite_flag = ifelse (length(save_flag) > 0 && save_flag == "Yes", TRUE, FALSE)

b_rasters = tbreak:::export_beast_rasters(beast_result, output_dir, output_prefix, overwrite_flag)


```

